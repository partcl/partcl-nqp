JAVA    = java
JAVAC   = javac
JAR     = jar
PERL    = perl 
PROVE   = prove
NQP     = @nqp@

PREFIX = @prefix@
NQP_PREFIX = @nqp_prefix@

# locations of nqp resources
NQP             = $(NQP_PREFIX)/bin/nqp$(EXE)

# helpers
RM_F            = $(PERL) -MExtUtils::Command -e rm_f
CP              = $(PERL) -MExtUtils::Command -e cp 
MKPATH          = $(PERL) -MExtUtils::Command -e mkpath
CHMOD           = $(PERL) -MExtUtils::Command -e chmod
# XXX very slow on nqp-jvm, use eval server?
#ECHO            = $(NQP) tools/build/echo.nqp
#CAT             = $(NQP) tools/build/cat.nqp
ECHO            = echo
CAT             = cat

# install path
PARTCL_EXE = partcl$(EXE)

# compiled
EXT = jar

COMMANDS = \
  src/Partcl/commands/after.pm \
  src/Partcl/commands/apply.pm \
  src/Partcl/commands/array.pm \
  src/Partcl/commands/binary.pm \
  src/Partcl/commands/break.pm \
  src/Partcl/commands/catch.pm \
  src/Partcl/commands/cd.pm \
  src/Partcl/commands/concat.pm \
  src/Partcl/commands/continue.pm \
  src/Partcl/commands/dict.pm \
  src/Partcl/commands/eof.pm \
  src/Partcl/commands/encoding.pm \
  src/Partcl/commands/error.pm \
  src/Partcl/commands/eval.pm \
  src/Partcl/commands/exit.pm \
  src/Partcl/commands/expr.pm \
  src/Partcl/commands/fileevent.pm \
  src/Partcl/commands/file.pm \
  src/Partcl/commands/flush.pm \
  src/Partcl/commands/foreach.pm \
  src/Partcl/commands/format.pm \
  src/Partcl/commands/for.pm \
  src/Partcl/commands/gets.pm \
  src/Partcl/commands/global.pm \
  src/Partcl/commands/glob.pm \
  src/Partcl/commands/if.pm \
  src/Partcl/commands/incr.pm \
  src/Partcl/commands/info.pm \
  src/Partcl/commands/interp.pm \
  src/Partcl/commands/join.pm \
  src/Partcl/commands/lappend.pm \
  src/Partcl/commands/lassign.pm \
  src/Partcl/commands/lindex.pm \
  src/Partcl/commands/linsert.pm \
  src/Partcl/commands/list.pm \
  src/Partcl/commands/llength.pm \
  src/Partcl/commands/lrange.pm \
  src/Partcl/commands/lrepeat.pm \
  src/Partcl/commands/lreplace.pm \
  src/Partcl/commands/lreverse.pm \
  src/Partcl/commands/lset.pm \
  src/Partcl/commands/lsort.pm \
  src/Partcl/commands/namespace.pm \
  src/Partcl/commands/package.pm \
  src/Partcl/commands/proc.pm \
  src/Partcl/commands/puts.pm \
  src/Partcl/commands/pwd.pm \
  src/Partcl/commands/regexp.pm \
  src/Partcl/commands/string.pm \
  src/Partcl/commands/subst.pm \
  src/Partcl/commands/switch.pm \
  src/Partcl/commands/split.pm \
  src/Partcl/commands/unset.pm \
  src/Partcl/commands/uplevel.pm \
  src/Partcl/commands/trace.pm \
  src/Partcl/commands/upvar.pm \
  src/Partcl/commands/variable.pm \
  src/Partcl/commands/vwait.pm \
  src/Partcl/commands/while.pm \
  src/Partcl/commands/socket.pm \
  src/Partcl/commands/source.pm \
  src/Partcl/commands/rename.pm \
  src/Partcl/commands/return.pm \
  src/Partcl/commands/append.pm \
  src/Partcl/commands/time.pm \
  src/Partcl/commands/set.pm \

BROKEN_COMMANDS = \

HELPERS = \
  src/Partcl/commands/string_helper.pm \
  src/Partcl/commands/array_helper.pm \
  src/Partcl/commands/file_helper.pm \
  src/Partcl/commands/info_helper.pm \
  src/Partcl/commands/namespace_helper.pm

GEN_SOURCES = \
  src/Partcl/commands.$(EXT) \
  src/ARE/Actions.$(EXT) \
  src/ARE/Compiler.$(EXT) \
  src/ARE/Grammar.$(EXT) \
  src/StringGlob/Actions.$(EXT) \
  src/StringGlob/Compiler.$(EXT) \
  src/StringGlob/Grammar.$(EXT) \
  src/FileGlob/Actions.$(EXT) \
  src/FileGlob/Compiler.$(EXT) \
  src/FileGlob/Grammar.$(EXT) \
  src/Partcl/Operators.$(EXT) \
  src/Internals.$(EXT) \
  src/TclArray.$(EXT) \
  src/TclLexPad.$(EXT) \
  src/TclList.$(EXT) \
  src/TclString.$(EXT) \
  src/options.$(EXT) \
  src/init.$(EXT)

all: src/Partcl.jar .revision

src/Partcl.$(EXT): $(GEN_SOURCES) 
src/Partcl/commands.pm: $(COMMANDS) $(HELPERS) src/init.$(EXT) src/TclList.$(EXT) \
    src/Partcl/Actions.pm src/Partcl/Compiler.pm src/Partcl/Grammar.pm\
    src/Internals.pm
	$(ECHO) "use src::init;"              > src/Partcl/commands.pm
	$(ECHO) "use src::TclList;"          >> src/Partcl/commands.pm
	$(CAT)  src/Partcl/Grammar.pm        >> src/Partcl/commands.pm
	$(CAT)  src/Partcl/Actions.pm        >> src/Partcl/commands.pm
	$(CAT)  src/Partcl/Compiler.pm       >> src/Partcl/commands.pm
	$(ECHO) "class Builtins {"           >> src/Partcl/commands.pm
	$(CAT)  $(COMMANDS)                  >> src/Partcl/commands.pm
	$(ECHO) "}"                          >> src/Partcl/commands.pm
	$(CAT)  src/Internals.pm             >> src/Partcl/commands.pm
	$(CAT)  $(HELPERS)                   >> src/Partcl/commands.pm

src/init.pm: src/TclLexPad.$(EXT) src/TclArray.$(EXT)
src/FileGlob/Actions.pm: src/StringGlob/Actions.$(EXT)
src/FileGlob/Grammar.pm: src/StringGlob/Grammar.$(EXT)

.SUFFIXES: .pm .$(EXT)
.pm.$(EXT):
	$(NQP) --target=$(EXT) --output=$@ $<

Makefile: ConfigureJVM.pl tools/build/Makefile-JVM.in
	$(PERL) ConfigureJVM.pl

## testing
test: $(PARTCL_EXE)
	prove -s --exec=./$(PARTCL_EXE) -r t
testj: $(PARTCL_EXE)
	prove -s -j3 --exec=./$(PARTCL_EXE) -r t

# Do our tests actually work with our target tclsh?
test-tcl:
	prove -s --exec=tclsh8.5 -r t

fulltest: test

## cleaning

clean:
	$(RM_F) partcl* revision 
	$(RM_F) $(GEN_SOURCES) src/Partcl.$(EXT)
	$(RM_F) src/Partcl/commands/*.$(EXT) src/Partcl/commands.pm

distclean: realclean

realclean: clean
	$(RM_F) Makefile

install:
	$(ECHO) "Install temporarily disabled" 

.PHONY : .revision
.revision:
	@git log -1 --pretty=format:%H > .revision

# nqp::makefile
