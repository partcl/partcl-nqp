# Copyright (C) 2006-2009, The Perl Foundation.

# values from parrot_config
EXE             = @exe@
PERL            = @perl@
RM_F            = @rm_f@
CP              = @cp@
MKPATH          = $(PERL) -MExtUtils::Command -e mkpath
CHMOD           = $(PERL) -MExtUtils::Command -e chmod
PARROT_VERSION  = @versiondir@
PARROT_BIN_DIR  = @bindir@
PARROT_LIB_DIR  = @libdir@$(PARROT_VERSION)

# locations of parrot resources
PARROT           = $(PARROT_BIN_DIR)/parrot$(EXE)
NQP              = $(PARROT_BIN_DIR)/nqp$(EXE)
PBC_TO_EXE       = $(PARROT_BIN_DIR)/pbc_to_exe$(EXE)

# install path
PARTCL_LANG_DIR = $(PARROT_LIB_DIR)/languages/partcl

PARTCL_EXE = partcl$(EXE)

COMMANDS = \
  src/Partcl/commands/after.pm \
  src/Partcl/commands/append.pm \
  src/Partcl/commands/apply.pm \
  src/Partcl/commands/array.pm \
  src/Partcl/commands/binary.pm \
  src/Partcl/commands/break.pm \
  src/Partcl/commands/catch.pm \
  src/Partcl/commands/cd.pm \
  src/Partcl/commands/concat.pm \
  src/Partcl/commands/continue.pm \
  src/Partcl/commands/dict.pm \
  src/Partcl/commands/eof.pm \
  src/Partcl/commands/encoding.pm \
  src/Partcl/commands/error.pm \
  src/Partcl/commands/eval.pm \
  src/Partcl/commands/exit.pm \
  src/Partcl/commands/expr.pm \
  src/Partcl/commands/fileevent.pm \
  src/Partcl/commands/file.pm \
  src/Partcl/commands/flush.pm \
  src/Partcl/commands/foreach.pm \
  src/Partcl/commands/format.pm \
  src/Partcl/commands/for.pm \
  src/Partcl/commands/gets.pm \
  src/Partcl/commands/global.pm \
  src/Partcl/commands/glob.pm \
  src/Partcl/commands/if.pm \
  src/Partcl/commands/incr.pm \
  src/Partcl/commands/info.pm \
  src/Partcl/commands/interp.pm \
  src/Partcl/commands/join.pm \
  src/Partcl/commands/lappend.pm \
  src/Partcl/commands/lassign.pm \
  src/Partcl/commands/lindex.pm \
  src/Partcl/commands/linsert.pm \
  src/Partcl/commands/list.pm \
  src/Partcl/commands/llength.pm \
  src/Partcl/commands/lrange.pm \
  src/Partcl/commands/lrepeat.pm \
  src/Partcl/commands/lreplace.pm \
  src/Partcl/commands/lreverse.pm \
  src/Partcl/commands/lset.pm \
  src/Partcl/commands/lsort.pm \
  src/Partcl/commands/namespace.pm \
  src/Partcl/commands/package.pm \
  src/Partcl/commands/proc.pm \
  src/Partcl/commands/puts.pm \
  src/Partcl/commands/pwd.pm \
  src/Partcl/commands/regexp.pm \
  src/Partcl/commands/rename.pm \
  src/Partcl/commands/return.pm \
  src/Partcl/commands/set.pm \
  src/Partcl/commands/socket.pm \
  src/Partcl/commands/source.pm \
  src/Partcl/commands/split.pm \
  src/Partcl/commands/string.pm \
  src/Partcl/commands/subst.pm \
  src/Partcl/commands/switch.pm \
  src/Partcl/commands/time.pm \
  src/Partcl/commands/trace.pm \
  src/Partcl/commands/unset.pm \
  src/Partcl/commands/uplevel.pm \
  src/Partcl/commands/upvar.pm \
  src/Partcl/commands/variable.pm \
  src/Partcl/commands/vwait.pm \
  src/Partcl/commands/while.pm

GEN_SOURCES = \
  src/Partcl/commands.pir \
  src/ARE/Actions.pir \
  src/ARE/Compiler.pir \
  src/ARE/Grammar.pir \
  src/StringGlob/Actions.pir \
  src/StringGlob/Compiler.pir \
  src/StringGlob/Grammar.pir \
  src/FileGlob/Actions.pir \
  src/FileGlob/Compiler.pir \
  src/FileGlob/Grammar.pir \
  src/Partcl/Actions.pir \
  src/Partcl/Compiler.pir \
  src/Partcl/Grammar.pir \
  src/Partcl/Operators.pir \
  src/Internals.pir \
  src/TclArray.pir \
  src/TclLexPad.pir \
  src/TclList.pir \
  src/TclString.pir \
  src/options.pir \
  src/init.pir

all: $(PARTCL_EXE) .revision

src/Partcl.pir: $(GEN_SOURCES) 
src/Partcl/commands.pm: $(COMMANDS) src/init.pir
	echo "use src::init;"    > src/Partcl/commands.pm
	echo "class Builtins {" >> src/Partcl/commands.pm
	cat $(COMMANDS)         >> src/Partcl/commands.pm
	echo "}"                >> src/Partcl/commands.pm

src/Internals.pm: src/Partcl/commands.pir src/init.pm
src/init.pm: src/TclLexPad.pir src/TclArray.pir
src/FileGlob/Actions.pm: src/StringGlob/Actions.pir
src/Partcl/Actions.pm: src/Internals.pir
src/FileGlob/Grammar.pm: src/StringGlob/Grammar.pir

$(PARTCL_EXE) : partcl.pbc
	$(PBC_TO_EXE) partcl.pbc

partcl.pbc : src/Partcl.pir
	$(PARROT) -o $@ src/Partcl.pir

.SUFFIXES: .pm .pir
.pm.pir:
	$(NQP) --target=pir --output=$@ $<

Makefile: Configure.pl build/Makefile.in
	$(PERL) Configure.pl

## testing
test: $(PARTCL_EXE)
	prove -s --exec=./$(PARTCL_EXE) -r t
testj: $(PARTCL_EXE)
	prove -s -j3 --exec=./$(PARTCL_EXE) -r t

# Do our tests actually work with our target tclsh?
test-tcl:
	prove -s --exec=tclsh8.5 -r t

fulltest: test

## cleaning

clean:
	$(RM_F) partcl* revision 
	$(RM_F) $(GEN_SOURCES) src/Partcl.pir
	$(RM_F) src/Partcl/commands/*.pir src/Partcl/commands.pm

distclean: realclean

realclean: clean
	$(RM_F) Makefile

testclean:


install: all
	$(CP)     partcl.pbc          $(DESTDIR)$(PARTCL_LANG_DIR) 
	$(MKPATH)                     $(DESTDIR)$(PARROT_BIN_DIR)
	$(CP)     $(PARTCL_EXE)       $(DESTDIR)$(PARROT_BIN_DIR)/$(PARTCL_EXE)
	$(CHMOD)  775                 $(DESTDIR)$(PARROT_BIN_DIR)/$(PARTCL_EXE)

.PHONY : .revision
.revision:
	@git log -1 --pretty=format:%H > .revision
