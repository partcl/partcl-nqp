# Copyright (C) 2006-2009, The Perl Foundation.

# values from parrot_config
PARROT_BIN_DIR  = @bindir@
EXE             = @exe@
PERL            = @perl@  # used implicitly by RM_F
RM_F            = @rm_f@

# locations of parrot resources
PARROT           = $(PARROT_BIN_DIR)/parrot$(EXE)
PARROT_NQP       = $(PARROT_BIN_DIR)/parrot-nqp$(EXE)
PBC_TO_EXE       = $(PARROT_BIN_DIR)/pbc_to_exe$(EXE)

PARTCL_EXE = partcl$(EXE)

GEN_SOURCES = \
  src/ARE/Actions.pir \
  src/ARE/Compiler.pir \
  src/ARE/Grammar.pir \
  src/StringGlob/Actions.pir \
  src/StringGlob/Compiler.pir \
  src/StringGlob/Grammar.pir \
  src/FileGlob/Actions.pir \
  src/FileGlob/Compiler.pir \
  src/FileGlob/Grammar.pir \
  src/Partcl/Actions.pir \
  src/Partcl/Compiler.pir \
  src/Partcl/Grammar.pir \
  src/Partcl/Operators.pir \
  src/Partcl/commands/array.pir \
  src/Partcl/commands/dict.pir \
  src/Partcl/commands/file.pir \
  src/Partcl/commands/info.pir \
  src/Partcl/commands/interp.pir \
  src/Partcl/commands/main.pir \
  src/Partcl/commands/namespace.pir \
  src/Partcl/commands/package.pir \
  src/Partcl/commands/string.pir \
  src/Partcl/commands/trace.pir \
  src/TclLexPad.pir \
  src/TclList.pir \
  src/TclString.pir \
  src/init.pir \
  src/options.pir

$(PARTCL_EXE) : partcl.pbc
	$(PBC_TO_EXE) partcl.pbc

partcl.pbc : src/Partcl.pir $(GEN_SOURCES)
	$(PARROT) -o $@ $<

.SUFFIXES: .pm .pir
.pm.pir:
	$(PARROT_NQP) --target=pir -o $@ $<

## testing

TEST_FILES = \
  t/sanity.t \
  t/cmd_after.t \
  t/cmd_append.t \
  t/cmd_concat.t \
  t/cmd_eof.t \
  t/cmd_error.t \
  t/cmd_flush.t \
  t/cmd_for.t \
  t/cmd_foreach.t \
  t/cmd_incr.t \
  t/cmd_join.t \
  t/cmd_lappend.t \
  t/cmd_lassign.t \
  t/cmd_lindex.t \
  t/cmd_linsert.t \
  t/cmd_list.t \
  t/cmd_llength.t \
  t/cmd_lrange.t \
  t/cmd_lrepeat.t \
  t/cmd_lreplace.t \
  t/cmd_lreverse.t \
  t/cmd_lset.t \
  t/cmd_split.t \
  t/cmd_string.t \
  t/cmd_time.t \
  t/cmd_while.t \
  t/tcl_conversion.t \
  t/tcl_command_subst.t \
  t/tcl_glob.t

# These t/*.t files are not yet runnable. Keep a list around so we know
# what to work on.
# t/cmd_apply.t t/cmd_array.t t/cmd_binary.t t/cmd_break.t
# t/cmd_catch.t t/cmd_continue.t t/cmd_eval.t t/cmd_expr.t t/cmd_file.t
# t/cmd_fileevent.t t/cmd_format.t t/cmd_gets.t
# t/cmd_global.t t/cmd_if.t t/cmd_info.t
# t/cmd_lsort.t t/cmd_namespace.t
# t/cmd_proc.t t/cmd_regexp.t t/cmd_return.t t/cmd_set.t t/cmd_socket.t
# t/cmd_subst.t t/cmd_switch.t t/cmd_trace.t t/cmd_unset.t t/cmd_upvar.t
# t/cmd_variable.t t/cmd_vwait.t t/tcl_backslash.t
# t/tcl_misc.t t/tcl_namespace.t t/tcl_var_subst.t

# Only those tests that pass for now.
test: $(PARTCL_EXE)
	prove -s --exec=./$(PARTCL_EXE) $(TEST_FILES)
testj: $(PARTCL_EXE)
	prove -s -j3 --exec=./$(PARTCL_EXE) $(TEST_FILES)

# Expected to fail.
fulltest:
	prove -s -j3 -r --exec=./$(PARTCL_EXE) t

## cleaning

clean:
	$(RM_F) partcl*
	$(RM_F) $(GEN_SOURCES)

distclean: realclean

realclean: clean
	$(RM_F) Makefile

testclean:
